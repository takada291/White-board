<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›»å­é»’æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #222; 
            color: white; 
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            height: 100vh;
            width: 100vw;
            margin: 0;
        }

        /* ç¸¦ç”»é¢ã®æ™‚ã®è­¦å‘Šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #portrait-warning {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ¨ªä¸¦ã³ï¼‰ */
        .app-container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* å·¦å´ï¼šã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        .camera-area {
            flex: 1; /* æ®‹ã‚Šã®å¹…å…¨éƒ¨ */
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«è¡¨ç¤º */
        }

        /* å³å´ï¼šæ“ä½œãƒ‘ãƒãƒ« */
        .control-panel {
            width: 320px; /* å›ºå®šå¹… */
            background: #333;
            padding: 15px;
            overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
            border-left: 1px solid #555;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .form-control-sm {
            background-color: #444;
            color: white;
            border: 1px solid #666;
        }
        .form-control-sm:focus {
            background-color: #555;
            color: white;
        }
        label { font-size: 0.8rem; color: #ccc; }

        /* æ’®å½±ãƒœã‚¿ãƒ³ */
        .shutter-btn {
            width: 100%;
            padding: 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: auto; /* ä¸‹ã«å¯„ã›ã‚‹ */
        }
        .shutter-btn:active { transform: scale(0.98); }

        /* é»’æ¿ä½ç½®åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ */
        .pos-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .pos-btn {
            flex: 1;
            padding: 5px;
            font-size: 0.8rem;
            background: #555;
            border: 1px solid #777;
            color: #aaa;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
        }
        .pos-btn.active {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        /* éè¡¨ç¤ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #outputCanvas { display: none; }
    </style>
</head>
<body>

    <div id="portrait-warning">
        <h1>ğŸ“±ãã‚‹ã£ã¨å›è»¢</h1>
        <p>ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„<br>ï¼ˆç¾å ´å†™çœŸã¯æ¨ªé•·ãŒåŸºæœ¬ã§ã™ï¼‰</p>
    </div>

    <div class="app-container">
        <div class="camera-area">
            <video id="cameraVideo" autoplay playsinline muted></video>
            <canvas id="outputCanvas"></canvas>
        </div>

        <div class="control-panel">
            <h6 class="text-center border-bottom pb-2">é›»å­é»’æ¿è¨­å®š</h6>

            <label>é»’æ¿ã®ä½ç½®</label>
            <div class="pos-switch">
                <div class="pos-btn" onclick="setBoardPos('left')" id="btnLeft">å·¦ä¸‹</div>
                <div class="pos-btn active" onclick="setBoardPos('right')" id="btnRight">å³ä¸‹</div>
            </div>

            <div>
                <label>1. å·¥äº‹åãƒ»æ¥­å‹™å</label>
                <input type="text" id="input1" class="form-control form-control-sm" value="R7å¹´åº¦ ä½œæ¥­é“é–‹è¨­">
            </div>
            <div>
                <label>2. å·¥ç¨®ãƒ»ä½œæ¥­å†…å®¹</label>
                <input type="text" id="input2" class="form-control form-control-sm" value="è·¯ç¶²ä½œè¨­å·¥">
            </div>
            <div>
                <label>3. æ¸¬ç‚¹ãƒ»è©³ç´°</label>
                <input type="text" id="input3" class="form-control form-control-sm" value="No.0">
            </div>
            <div>
                <label>4. å‚™è€ƒãƒ»æ—¥ä»˜ãªã©</label>
                <input type="text" id="input4" class="form-control form-control-sm" value="">
            </div>

            <button class="shutter-btn" onclick="takePhoto()">
                ğŸ“¸ æ’®å½±ãƒ»ä¿å­˜
            </button>
            <p class="text-center text-muted mt-1" style="font-size:0.7rem;">
                â€»iPhoneã¯ã€Œå…±æœ‰ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰<br>ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ãã ã•ã„
            </p>
        </div>
    </div>

<script>
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const warning = document.getElementById('portrait-warning');
    
    // æ—¥ä»˜ã®åˆæœŸã‚»ãƒƒãƒˆ
    const today = new Date();
    const dateStr = today.getFullYear() + '/' + (today.getMonth()+1) + '/' + today.getDate();
    document.getElementById('input4').value = dateStr; // 4è¡Œç›®ã«æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹

    // é»’æ¿ã®ä½ç½®ç®¡ç† ('right' or 'left')
    let boardPosition = 'right';

    function setBoardPos(pos) {
        boardPosition = pos;
        document.getElementById('btnLeft').className = pos === 'left' ? 'pos-btn active' : 'pos-btn';
        document.getElementById('btnRight').className = pos === 'right' ? 'pos-btn active' : 'pos-btn';
    }

    // ç¸¦æ¨ªæ¤œçŸ¥
    function checkOrientation() {
        if (window.innerWidth < window.innerHeight) {
            warning.style.display = 'flex'; // ç¸¦ãªã‚‰è­¦å‘Šè¡¨ç¤º
        } else {
            warning.style.display = 'none'; // æ¨ªãªã‚‰è­¦å‘Šæ¶ˆã™
        }
    }
    window.addEventListener('resize', checkOrientation);
    checkOrientation(); // åˆå›å®Ÿè¡Œ

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message);
        }
    }

    // é»’æ¿æç”»å‡¦ç†
    function drawBlackboard() {
        // è§£åƒåº¦åˆã‚ã›
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // 1. å†™çœŸã‚’æç”»
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 2. é»’æ¿ã®ã‚µã‚¤ã‚ºè¨ˆç®—ï¼ˆå°‘ã—å°ã•ãèª¿æ•´ï¼šå¹…ã®25%ï¼‰
        const boardWidth = canvas.width * 0.25; 
        const boardHeight = boardWidth * 0.75; // 4:3
        const margin = canvas.width * 0.02; // ç«¯ã‹ã‚‰2%ã®ä½™ç™½

        // 3. ä½ç½®ã®è¨ˆç®—
        let x, y;
        y = canvas.height - boardHeight - margin; // ä¸‹ç«¯ã¯å…±é€š
        if (boardPosition === 'right') {
            x = canvas.width - boardWidth - margin; // å³å¯„ã›
        } else {
            x = margin; // å·¦å¯„ã›
        }

        // 4. é»’æ¿ã®èƒŒæ™¯ï¼ˆæ·±ç·‘ï¼‰
        ctx.fillStyle = "#004d26"; 
        ctx.fillRect(x, y, boardWidth, boardHeight);
        
        // æ ç·šï¼ˆç™½ï¼‰
        ctx.strokeStyle = "white";
        ctx.lineWidth = boardWidth * 0.01;
        ctx.strokeRect(x, y, boardWidth, boardHeight);

        // ä»•åˆ‡ã‚Šç·šï¼ˆæ¨ªç·š3æœ¬ã§4è¡Œã«ã™ã‚‹ï¼‰
        const rowH = boardHeight / 4;
        ctx.beginPath();
        ctx.moveTo(x, y + rowH * 1); ctx.lineTo(x + boardWidth, y + rowH * 1);
        ctx.moveTo(x, y + rowH * 2); ctx.lineTo(x + boardWidth, y + rowH * 2);
        ctx.moveTo(x, y + rowH * 3); ctx.lineTo(x + boardWidth, y + rowH * 3);
        ctx.stroke();

        // 5. æ–‡å­—ã‚’æç”»
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆå°‘ã—å°ã•ã‚ã«èª¿æ•´ï¼‰
        const fontSize = Math.floor(rowH * 0.55); 
        ctx.font = `bold ${fontSize}px Arial`;

        // å„è¡Œã®å†…å®¹ã‚’å–å¾—
        const texts = [
            document.getElementById('input1').value,
            document.getElementById('input2').value,
            document.getElementById('input3').value,
            document.getElementById('input4').value
        ];

        // 4è¡Œæ›¸ãè¾¼ã¿
        for (let i = 0; i < 4; i++) {
            const textY = y + (rowH * i) + (rowH / 2);
            // æ–‡å­—å¹…ãŒæº¢ã‚Œã‚‹å ´åˆã®ç¸®å°å‡¦ç†ã¯ç°¡æ˜“çš„ã«æ–‡å­—æ•°åˆ¶é™ã‹ã‘ã‚‹ã‹ã€
            // ã“ã“ã§ã¯ãã®ã¾ã¾æç”»ï¼ˆãƒ•ã‚©ãƒ³ãƒˆå°ã•ãã—ãŸã®ã§å…¥ã‚Šã‚„ã™ã„ã¯ãšï¼‰
            ctx.fillText(texts[i], x + boardWidth / 2, textY);
        }
    }

    // æ’®å½±ãƒ»ä¿å­˜ãƒ»å…±æœ‰å‡¦ç†
    async function takePhoto() {
        drawBlackboard();

        canvas.toBlob(async (blob) => {
            if (!blob) return;

            // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
            const now = new Date();
            const fileName = `kokuban_${now.getTime()}.jpg`;
            const file = new File([blob], fileName, { type: "image/jpeg" });

            // Web Share APIï¼ˆå…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ãŒä½¿ãˆã‚‹å ´åˆï¼ˆä¸»ã«ã‚¹ãƒãƒ›ï¼‰
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'é›»å­é»’æ¿å†™çœŸ',
                        text: 'ç¾å ´å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'
                    });
                    // æˆåŠŸã—ãŸã‚‰ã“ã“ã§çµ‚äº†ï¼ˆå…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸ã‚“ã§ã‚‚ã‚‰ã†ï¼‰
                    return; 
                } catch (err) {
                    console.log("å…±æœ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼", err);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¸é€²ã‚€
                }
            }

            // PCã‚„å…±æœ‰APIéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const link = document.createElement('a');
            link.download = fileName;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);

        }, 'image/jpeg', 0.95); // ç”»è³ª95%
    }

    window.onload = startCamera;
</script>
</body>
</html>
