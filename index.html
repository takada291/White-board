<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—æ¥­ç”¨ é›»å­å°é»’æ¿ã‚«ãƒ¡ãƒ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f0f0; padding-bottom: 50px; }
        /* ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background-color: #000;
            overflow: hidden;
        }
        /* ãƒ“ãƒ‡ã‚ªã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’é‡ã­ã‚‹è¨­å®š */
        #cameraVideo, #outputCanvas {
            width: 100%;
            height: auto;
            display: block;
        }
        /* å®Ÿéš›ã«è¡¨ç¤ºã™ã‚‹ã®ã¯Canvasï¼ˆåŠ å·¥å¾Œï¼‰ã ã‘ã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚Šã¾ã™ãŒã€
           ä»Šå›ã¯ã€Œãƒ“ãƒ‡ã‚ªï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã€ã®ä¸Šã«ã€ŒCanvasã€ã‚’è£ã§ä½œã‚Šã¾ã™ */
        #cameraVideo {
            /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ */
        }
        #outputCanvas {
            /* æ’®å½±ç”»åƒã®ç”Ÿæˆç”¨ï¼ˆæ™®æ®µã¯éè¡¨ç¤ºã§ã‚‚ã‚ˆã„ãŒã€ãƒ‡ãƒãƒƒã‚°ç”¨ã«éš ã—ã¦ãŠãï¼‰ */
            display: none; 
        }
        
        /* æ’®å½±ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .shutter-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #dc3545;
            border: 4px solid #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            cursor: pointer;
        }
        .shutter-icon {
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>

<div class="container mt-3">
    <h4 class="text-center mb-3">ğŸŒ² ç¾å ´ç”¨ é›»å­å°é»’æ¿</h4>

    <div class="camera-container rounded shadow-sm">
        <video id="cameraVideo" autoplay playsinline muted></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="card mt-3 shadow-sm">
        <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">é»’æ¿è¨˜è¼‰äº‹é …</h6>
            <div class="mb-2">
                <input type="text" id="projectInfo" class="form-control" placeholder="å·¥äº‹å (ä¾‹: ã€‡ã€‡ä½œæ¥­é“é–‹è¨­)" value="R7å¹´åº¦ ä½œæ¥­é“é–‹è¨­">
            </div>
            <div class="mb-2">
                <input type="text" id="workType" class="form-control" placeholder="å·¥ç¨® (ä¾‹: è·¯ç¶²ä½œè¨­å·¥)" value="è·¯ç¶²ä½œè¨­å·¥">
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <input type="text" id="positionInfo" class="form-control" placeholder="æ¸¬ç‚¹ (ä¾‹: No.1+10)" value="No.0">
                </div>
                <div class="col-6">
                    <input type="text" id="dateInfo" class="form-control" readonly>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <div class="shutter-btn" onclick="takePhoto()">
            <span class="shutter-icon">ğŸ“·</span>
        </div>
        <p class="text-muted mt-2 small">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±ãƒ»ä¿å­˜</p>
    </div>
</div>

<script>
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    
    // å…¥åŠ›é …ç›®
    const inputProject = document.getElementById('projectInfo');
    const inputWork = document.getElementById('workType');
    const inputPos = document.getElementById('positionInfo');
    const inputDate = document.getElementById('dateInfo');

    // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
    const today = new Date();
    inputDate.value = today.getFullYear() + '/' + (today.getMonth()+1) + '/' + today.getDate();

    // 1. ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°
    async function startCamera() {
        try {
            // ãƒªã‚¢ã‚«ãƒ¡ãƒ©ï¼ˆenvironmentï¼‰ã‚’å„ªå…ˆçš„ã«å–å¾—
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSã§æ¥ç¶šã—ã¦ã„ã‚‹ã‹ã€ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: " + err.name);
        }
    }

    // 2. é»’æ¿ã‚’æç”»ã™ã‚‹é–¢æ•°
    function drawBlackboard() {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ãƒ“ãƒ‡ã‚ªã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // ã¾ãšã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ï¼ˆä¸‹åœ°ï¼‰
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // é»’æ¿ã®è¨­å®šï¼ˆã‚µã‚¤ã‚ºã‚„ä½ç½®ï¼‰
        // ç”»åƒã®å³ä¸‹ã«é…ç½®ã™ã‚‹ã‚ˆã†ã«è¨ˆç®—
        const boardWidth = canvas.width * 0.35; // ç”»é¢å¹…ã®35%ã®å¤§ãã•
        const boardHeight = boardWidth * 0.75;  // 4:3ã®æ¯”ç‡
        const margin = 20; // ç«¯ã‹ã‚‰ã®ä½™ç™½
        
        const x = canvas.width - boardWidth - margin;
        const y = canvas.height - boardHeight - margin;

        // --- é»’æ¿ã®çµµã‚’æã ---
        
        // é»’æ¿ã®èƒŒæ™¯ï¼ˆæ·±ç·‘ï¼‰
        ctx.fillStyle = "#004d26"; 
        ctx.fillRect(x, y, boardWidth, boardHeight);

        // é»’æ¿ã®æ ç·šï¼ˆç™½ï¼‰
        ctx.strokeStyle = "white";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, boardWidth, boardHeight);

        // ä»•åˆ‡ã‚Šç·šï¼ˆæ¨ªç·šï¼‰
        ctx.beginPath();
        ctx.moveTo(x, y + boardHeight / 3);
        ctx.lineTo(x + boardWidth, y + boardHeight / 3);
        ctx.moveTo(x, y + (boardHeight / 3) * 2);
        ctx.lineTo(x + boardWidth, y + (boardHeight / 3) * 2);
        ctx.stroke();

        // --- æ–‡å­—ã‚’æ›¸ã ---
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆé»’æ¿ã®å¤§ãã•ã«åˆã‚ã›ã‚‹ï¼‰
        const fontSize = Math.floor(boardHeight / 5); 
        ctx.font = `bold ${fontSize}px Arial`;

        // å·¥äº‹å
        ctx.fillText(inputProject.value, x + boardWidth / 2, y + (boardHeight / 6));
        
        // å·¥ç¨®
        ctx.fillText(inputWork.value, x + boardWidth / 2, y + (boardHeight / 2));

        // æ¸¬ç‚¹ã¨æ—¥ä»˜ï¼ˆä¸‹æ®µã«ä¸¦ã¹ã‚‹ï¼‰
        const bottomText = inputPos.value + " | " + inputDate.value;
        ctx.font = `bold ${fontSize * 0.8}px Arial`; // å°‘ã—å°ã•ã
        ctx.fillText(bottomText, x + boardWidth / 2, y + (boardHeight / 6) * 5);
    }

    // 3. æ’®å½±ãƒ»ä¿å­˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
    function takePhoto() {
        // é»’æ¿ã‚’æç”»æ¸ˆã¿ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã‚‹
        drawBlackboard();

        // ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
        const link = document.createElement('a');
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¾åœ¨æ™‚åˆ»ã«ã™ã‚‹
        const now = new Date();
        const timeStr = now.getHours() + '' + now.getMinutes() + '' + now.getSeconds();
        link.download = 'genba_photo_' + timeStr + '.jpg';
        link.href = canvas.toDataURL('image/jpeg');
        link.click();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©èµ·å‹•
    window.onload = startCamera;

</script>
</body>
</html>