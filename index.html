<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›»å­é»’æ¿(GPSä»˜)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #222; 
            color: white; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            margin: 0;
            font-family: sans-serif;
        }

        #portrait-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            text-align: center; flex-direction: column;
        }

        .app-container { display: flex; height: 100%; width: 100%; }

        .camera-area {
            flex: 1; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        
        video { width: 100%; height: 100%; object-fit: contain; }

        .control-panel {
            width: 320px; background: #333; padding: 15px;
            overflow-y: auto; border-left: 1px solid #555;
            display: flex; flex-direction: column; gap: 10px;
        }

        .form-control-sm {
            background-color: #444; color: white; border: 1px solid #666;
        }
        .form-control-sm:focus { background-color: #555; color: white; }
        label { font-size: 0.8rem; color: #ccc; }

        .shutter-btn {
            width: 100%; padding: 15px;
            background-color: #dc3545; color: white;
            border: none; border-radius: 10px;
            font-weight: bold; font-size: 1.2rem; margin-top: auto;
        }
        .shutter-btn:active { transform: scale(0.98); }

        .pos-switch { display: flex; gap: 10px; margin-bottom: 5px; }
        .pos-btn {
            flex: 1; padding: 5px; font-size: 0.8rem;
            background: #555; border: 1px solid #777; color: #aaa;
            text-align: center; border-radius: 5px; cursor: pointer;
        }
        .pos-btn.active { background: #0d6efd; color: white; border-color: #0d6efd; }

        /* GPSã‚¹ã‚¤ãƒƒãƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .form-check-input { cursor: pointer; }
        .gps-status { font-size: 0.75rem; color: #ffd700; min-height: 1.2em; }

        #outputCanvas { display: none; }
    </style>
</head>
<body>

    <div id="portrait-warning">
        <h1>ğŸ“±ãã‚‹ã£ã¨å›è»¢</h1>
        <p>ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„</p>
    </div>

    <div class="app-container">
        <div class="camera-area">
            <video id="cameraVideo" autoplay playsinline muted></video>
            <canvas id="outputCanvas"></canvas>
        </div>

        <div class="control-panel">
            <h6 class="text-center border-bottom pb-2">é›»å­é»’æ¿è¨­å®š</h6>

            <div class="d-flex justify-content-between align-items-center">
                <label>é»’æ¿ä½ç½®</label>
                <div class="pos-switch" style="width: 60%;">
                    <div class="pos-btn" onclick="setBoardPos('left')" id="btnLeft">å·¦ä¸‹</div>
                    <div class="pos-btn active" onclick="setBoardPos('right')" id="btnRight">å³ä¸‹</div>
                </div>
            </div>

            <div class="form-check form-switch mt-1 border-bottom pb-2 mb-2">
                <input class="form-check-input" type="checkbox" id="gpsToggle" onchange="toggleGPS()">
                <label class="form-check-label" for="gpsToggle">ğŸ“ ä½ç½®ãƒ»æ–¹ä½æƒ…å ±ã‚’è¨˜éŒ²</label>
                <div id="gpsStatus" class="gps-status">OFF</div>
            </div>

            <div><label>1. å·¥äº‹å</label><input type="text" id="input1" class="form-control form-control-sm" value="R7å¹´åº¦ ä½œæ¥­é“é–‹è¨­"></div>
            <div><label>2. å·¥ç¨®</label><input type="text" id="input2" class="form-control form-control-sm" value="è·¯ç¶²ä½œè¨­å·¥"></div>
            <div><label>3. æ¸¬ç‚¹</label><input type="text" id="input3" class="form-control form-control-sm" value="No.0"></div>
            <div><label>4. æ—¥ä»˜ãƒ»å‚™è€ƒ</label><input type="text" id="input4" class="form-control form-control-sm" value=""></div>

            <button class="shutter-btn" onclick="takePhoto()">ğŸ“¸ æ’®å½±ãƒ»ä¿å­˜</button>
            <p class="text-center text-muted mt-1" style="font-size:0.7rem;">iPhoneã¯ã€Œå…±æœ‰ã€â†’ã€Œç”»åƒã‚’ä¿å­˜ã€</p>
        </div>
    </div>

<script>
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const warning = document.getElementById('portrait-warning');
    const gpsStatusDiv = document.getElementById('gpsStatus');

    // æ—¥ä»˜åˆæœŸåŒ–
    const today = new Date();
    document.getElementById('input4').value = today.getFullYear() + '/' + (today.getMonth()+1) + '/' + today.getDate();

    let boardPosition = 'right';
    function setBoardPos(pos) {
        boardPosition = pos;
        document.getElementById('btnLeft').className = pos === 'left' ? 'pos-btn active' : 'pos-btn';
        document.getElementById('btnRight').className = pos === 'right' ? 'pos-btn active' : 'pos-btn';
    }

    // ç¸¦æ¨ªæ¤œçŸ¥
    function checkOrientation() {
        warning.style.display = (window.innerWidth < window.innerHeight) ? 'flex' : 'none';
    }
    window.addEventListener('resize', checkOrientation);
    checkOrientation();

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false 
            });
            video.srcObject = stream;
        } catch (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message); }
    }
    window.onload = startCamera;

    // --- GPS & æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ ---
    let useGPS = false;
    let currentLat = null;
    let currentLon = null;
    let currentHeading = null; // æ–¹ä½ (0-360)
    let watchId = null;

    async function toggleGPS() {
        const checkbox = document.getElementById('gpsToggle');
        useGPS = checkbox.checked;

        if (useGPS) {
            gpsStatusDiv.innerText = "æ¸¬ä½ä¸­...";
            
            // 1. ä½ç½®æƒ…å ±ã®ç›£è¦–é–‹å§‹
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude.toFixed(5);
                        currentLon = pos.coords.longitude.toFixed(5);
                        updateStatusText();
                    },
                    (err) => { gpsStatusDiv.innerText = "GPSã‚¨ãƒ©ãƒ¼: " + err.message; },
                    { enableHighAccuracy: true }
                );
            }

            // 2. æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ï¼ˆiOSå¯¾å¿œï¼‰
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ ã¯è¨±å¯ãŒå¿…è¦
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    } else {
                        alert("æ–¹ä½ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
                    }
                } catch (e) { console.log(e); }
            } else {
                // Android / PCä»–
                window.addEventListener('deviceorientation', handleOrientation);
            }

        } else {
            // OFFã«ã™ã‚‹å‡¦ç†
            gpsStatusDiv.innerText = "OFF";
            if (watchId) navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('deviceorientation', handleOrientation);
            currentLat = null; currentLon = null; currentHeading = null;
        }
    }

    function handleOrientation(event) {
        // æ–¹ä½å–å¾— (iOS webkitCompassHeading, Android alpha)
        if (event.webkitCompassHeading) {
            currentHeading = event.webkitCompassHeading; // iOS
        } else if (event.alpha) {
            // Androidã®alphaã¯ã€ŒåŒ—=0ã€ã¨ã¯é™ã‚‰ãªã„ãŒã€ç°¡æ˜“çš„ã«ä½¿ç”¨
            // å³å¯†ã«ã¯çµ¶å¯¾æ–¹ä½(absolute)ã®è¨ˆç®—ãŒå¿…è¦ã ãŒã€ä»Šå›ã¯ç°¡æ˜“å®Ÿè£…
            currentHeading = 360 - event.alpha; 
        }
        updateStatusText();
    }

    function updateStatusText() {
        if (!useGPS) return;
        let text = "";
        if (currentLat) text += `N${currentLat} E${currentLon} `;
        if (currentHeading != null) text += ` æ–¹ä½:${Math.round(currentHeading)}Â°`;
        gpsStatusDiv.innerText = text || "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
    }

    // --- æç”»å‡¦ç† ---
    function drawBlackboard() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // é»’æ¿ã‚µã‚¤ã‚º
        const boardWidth = canvas.width * 0.25; 
        const boardHeight = boardWidth * 0.75; 
        const margin = canvas.width * 0.02;

        let x, y;
        // GPSæƒ…å ±ãŒã‚ã‚‹å ´åˆã€é»’æ¿ã®ä¸‹ã«å°‘ã—ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦æç”»ã™ã‚‹ã‹ã€
        // é»’æ¿ã®ä¸­ã«æŠ¼ã—è¾¼ã‚€ã‹ã€‚ä»Šå›ã¯ã€Œé»’æ¿ã®ä¸‹éƒ¨ã«è¿½åŠ æ ã€ã‚’ä½œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§
        const gpsAreaHeight = useGPS ? (boardHeight * 0.15) : 0; 
        const totalHeight = boardHeight + gpsAreaHeight;

        y = canvas.height - totalHeight - margin;
        x = (boardPosition === 'right') ? (canvas.width - boardWidth - margin) : margin;

        // é»’æ¿æœ¬ä½“ã®èƒŒæ™¯
        ctx.fillStyle = "#004d26"; 
        ctx.fillRect(x, y, boardWidth, boardHeight);
        
        // GPSã‚¨ãƒªã‚¢ã®èƒŒæ™¯ï¼ˆå°‘ã—æš—ãã™ã‚‹ã€ã‚ã‚‹ã„ã¯åŒã˜è‰²ï¼‰
        if (useGPS) {
            ctx.fillStyle = "#003319"; // å°‘ã—æ¿ƒã„ç·‘
            ctx.fillRect(x, y + boardHeight, boardWidth, gpsAreaHeight);
        }

        // å¤–æ 
        ctx.strokeStyle = "white";
        ctx.lineWidth = boardWidth * 0.01;
        ctx.strokeRect(x, y, boardWidth, totalHeight); // å…¨ä½“ã‚’å›²ã‚€

        // ç½«ç·š
        const rowH = boardHeight / 4;
        ctx.beginPath();
        ctx.moveTo(x, y + rowH * 1); ctx.lineTo(x + boardWidth, y + rowH * 1);
        ctx.moveTo(x, y + rowH * 2); ctx.lineTo(x + boardWidth, y + rowH * 2);
        ctx.moveTo(x, y + rowH * 3); ctx.lineTo(x + boardWidth, y + rowH * 3);
        if (useGPS) {
            // GPSã‚¨ãƒªã‚¢ã¨ã®å¢ƒç•Œç·š
            ctx.moveTo(x, y + boardHeight); ctx.lineTo(x + boardWidth, y + boardHeight);
        }
        ctx.stroke();

        // æ–‡å­—è¨­å®š
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // ãƒ¡ã‚¤ãƒ³é …ç›®
        const fontSize = Math.floor(rowH * 0.55); 
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.fillStyle = "white";

        const texts = [
            document.getElementById('input1').value,
            document.getElementById('input2').value,
            document.getElementById('input3').value,
            document.getElementById('input4').value
        ];

        for (let i = 0; i < 4; i++) {
            ctx.fillText(texts[i], x + boardWidth / 2, y + (rowH * i) + (rowH / 2));
        }

        // GPSæƒ…å ±ã®æç”»ï¼ˆæœ€ä¸‹éƒ¨ï¼‰
        if (useGPS) {
            ctx.fillStyle = "#ffff00"; // é»„è‰²ã§ç›®ç«‹ãŸã›ã‚‹
            const gpsFontSize = Math.floor(gpsAreaHeight * 0.6);
            ctx.font = `bold ${gpsFontSize}px monospace`; // ç­‰å¹…ãƒ•ã‚©ãƒ³ãƒˆ
            
            let gpsText = "GPSè¨ˆæ¸¬ä¸­...";
            if (currentLat && currentHeading != null) {
                // æ–¹ä½ã‚’çŸ¢å°ã«ã™ã‚‹æ‰‹ã‚‚ã‚ã‚Š
                gpsText = `N${currentLat} E${currentLon} / ${getCardinal(currentHeading)}`;
            } else if (currentLat) {
                gpsText = `N${currentLat} E${currentLon}`;
            }
            ctx.fillText(gpsText, x + boardWidth / 2, y + boardHeight + (gpsAreaHeight / 2));
        }
    }

    // æ–¹ä½è§’ã‚’æ–‡å­—ï¼ˆN, NE, E...ï¼‰ã«å¤‰æ›
    function getCardinal(angle) {
        const directions = ['Nâ†‘', 'NEâ†—', 'Eâ†’', 'SEâ†˜', 'Sâ†“', 'SWâ†™', 'Wâ†', 'NWâ†–'];
        return directions[Math.round(((angle %= 360) < 0 ? angle + 360 : angle) / 45) % 8];
    }

    // æ’®å½±å‡¦ç†ï¼ˆå¤‰æ›´ãªã—ï¼‰
    async function takePhoto() {
        drawBlackboard();
        canvas.toBlob(async (blob) => {
            if (!blob) return;
            const now = new Date();
            const fileName = `kokuban_${now.getTime()}.jpg`;
            const file = new File([blob], fileName, { type: "image/jpeg" });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'é»’æ¿å†™çœŸ' }); return; } catch (e) {}
            }
            const link = document.createElement('a');
            link.download = fileName; link.href = URL.createObjectURL(blob); link.click();
        }, 'image/jpeg', 0.95);
    }
</script>
</body>
</html>
