<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>White-board-v1.9</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004d26">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #222; 
            color: white; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            margin: 0;
            font-family: sans-serif;
        }

        /* æ›´æ–°é€šçŸ¥ãƒãƒ¼ */
        #update-notification {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: #ff9800; color: #000;
            padding: 10px; text-align: center; z-index: 9999;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #update-btn {
            background: #fff; border: 1px solid #333; 
            padding: 2px 10px; margin-left: 10px; cursor: pointer;
            border-radius: 3px;
        }

        /* ç¸¦ç”»é¢è­¦å‘Š */
        #portrait-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            text-align: center; flex-direction: column;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .app-container { display: flex; height: 100%; width: 100%; }

        /* å·¦å´ã‚¨ãƒªã‚¢ */
        .camera-area {
            flex: 1; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* å³å´ãƒ‘ãƒãƒ« */
        .control-panel {
            width: 320px; background: #333; padding: 10px;
            overflow-y: hidden; 
            border-left: 1px solid #555;
            display: flex; flex-direction: column;
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .tab-header {
            display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; padding: 10px; border: none; border-radius: 5px;
            font-weight: bold; font-size: 0.9rem; cursor: pointer;
            background-color: #555; color: #ccc; transition: 0.2s;
        }
        .tab-btn.active {
            background-color: #0d6efd; color: white;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸ */
        .tab-content {
            flex: 1; overflow-y: auto; display: none; flex-direction: column;
        }
        .tab-content.active {
            display: flex;
        }

        /* --- æ’®å½±ã‚¿ãƒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .shutter-btn-large {
            width: 100%; 
            flex: 1; min-height: 120px;
            background-color: #dc3545; color: white;
            border: none; border-radius: 15px;
            font-weight: bold; font-size: 2rem;
            margin-top: auto; margin-bottom: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .shutter-btn-large:active { transform: scale(0.98); box-shadow: 0 3px 6px rgba(0,0,0,0.5); }

        /* ã€æ–°æ©Ÿèƒ½ã€‘ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”é¸æŠãƒœã‚¿ãƒ³ */
        .ratio-group label {
            font-size: 0.9rem; font-weight: bold; padding: 10px 0;
        }
        .btn-check:checked + .btn-outline-light {
            background-color: #0d6efd; border-color: #0d6efd; color: white;
        }
        .btn-outline-light {
            color: #ccc; border-color: #666;
        }

        /* ã€æ”¹å–„ã€‘GPSã‚¹ã‚¤ãƒƒãƒå¤§å‹åŒ– */
        .form-check-input { 
            cursor: pointer; 
            width: 4rem; height: 2rem; /* ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ— */
        }
        .gps-status { font-size: 0.8rem; color: #ffd700; min-height: 1.2em; margin-top: 5px;}


        /* --- è¨˜å…¥ã‚¿ãƒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .form-control-sm {
            background-color: #444; color: white; border: 1px solid #666; font-size: 0.9rem; padding: 6px;
        }
        .form-control-sm:focus { background-color: #555; color: white; }
        label { font-size: 0.8rem; color: #ccc; margin-top: 5px; margin-bottom: 2px; }

        .preset-box {
            background: #444; padding: 10px; border-radius: 5px; margin-bottom: 10px;
        }
        .preset-btn-group {
            display: flex; gap: 5px; margin-top: 5px;
        }
        .preset-btn {
            flex: 1; font-size: 0.8rem; padding: 8px; border: none; border-radius: 3px; cursor: pointer;
        }
        .btn-load { background: #0d6efd; color: white; }
        .btn-save { background: #198754; color: white; }

        /* å…±é€šUIãƒ‘ãƒ¼ãƒ„ */
        .pos-switch { display: flex; gap: 10px; margin-bottom: 5px; }
        .pos-btn {
            flex: 1; padding: 8px; font-size: 0.9rem;
            background: #555; border: 1px solid #777; color: #aaa;
            text-align: center; border-radius: 5px; cursor: pointer;
        }
        .pos-btn.active { background: #0d6efd; color: white; border-color: #0d6efd; }

        #outputCanvas { display: none; }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ï¼ˆå·¦å³é…ç½®ç‰ˆï¼‰ */
        #previewOverlay {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            flex-direction: row; 
            align-items: center; justify-content: center;
        }
        #previewImg {
            max-width: 75%; max-height: 90%; 
            border: 2px solid white; margin-right: 20px;
        }
        .preview-btns { 
            display: flex; flex-direction: column; gap: 30px; 
        }
        .preview-action-btn {
            padding: 20px 10px; width: 120px;
            border: none; color: white; border-radius: 10px; 
            font-weight: bold; font-size: 1.1rem;
        }
        .btn-retake { background: #6c757d; }
        .btn-save { background: #0d6efd; font-size: 1.3rem; }

    </style>
</head>
<body>

    <div id="update-notification">
        æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™
        <button id="update-btn" onclick="updateApp()">æ›´æ–°ã™ã‚‹</button>
    </div>

    <div id="portrait-warning">
        <h1>ğŸ“±ãã‚‹ã£ã¨å›è»¢</h1>
        <p>ã‚¹ãƒãƒ›ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„</p>
    </div>

    <div id="previewOverlay">
        <img id="previewImg" src="">
        <div class="preview-btns">
            <button class="preview-action-btn btn-save" onclick="savePhoto()">ğŸ’¾ ä¿å­˜</button>
            <button class="preview-action-btn btn-retake" onclick="cancelPreview()">â†© æ’®ç›´</button>
        </div>
    </div>

    <div class="app-container">
        <div class="camera-area">
            <video id="cameraVideo" autoplay playsinline muted></video>
            <canvas id="outputCanvas"></canvas>
        </div>

        <div class="control-panel">
            <div class="tab-header">
                <button class="tab-btn active" onclick="switchTab('shoot')" id="tabBtn-shoot">ğŸ“¸ æ’®å½±</button>
                <button class="tab-btn" onclick="switchTab('edit')" id="tabBtn-edit">ğŸ“ è¨˜å…¥</button>
            </div>

            <div id="tab-shoot" class="tab-content active">
                <h6 class="text-center text-muted border-bottom pb-2">æ’®å½±è¨­å®š</h6>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label style="font-size:0.9rem;">é»’æ¿ä½ç½®_v1.9</label>
                    <div class="pos-switch" style="width: 60%;">
                        <div class="pos-btn" onclick="setBoardPos('left')" id="btnLeft">å·¦ä¸‹</div>
                        <div class="pos-btn active" onclick="setBoardPos('right')" id="btnRight">å³ä¸‹</div>
                    </div>
                </div>

                <div class="form-check form-switch border-bottom pb-3 mb-3">
                    <input class="form-check-input" type="checkbox" id="gpsToggle" onchange="toggleGPS()">
                    <label class="form-check-label ms-2 mt-1" for="gpsToggle" style="font-size:1rem;">ğŸ“ ä½ç½®ãƒ»æ–¹ä½æƒ…å ±</label>
                    <div id="gpsStatus" class="gps-status">OFF</div>
                </div>

                <div class="mb-3">
                    <label class="text-muted small mb-1">ç”»è§’ (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”)</label>
                    <div class="btn-group w-100 ratio-group" role="group">
                        <input type="radio" class="btn-check" name="ratio" id="r169" autocomplete="off" checked onchange="setRatio(1.7777)">
                        <label class="btn btn-outline-light" for="r169">16:9</label>

                        <input type="radio" class="btn-check" name="ratio" id="r43" autocomplete="off" onchange="setRatio(1.3333)">
                        <label class="btn btn-outline-light" for="r43">4:3</label>

                        <input type="radio" class="btn-check" name="ratio" id="r11" autocomplete="off" onchange="setRatio(1.0)">
                        <label class="btn btn-outline-light" for="r11">1:1</label>
                    </div>
                </div>
                
                <div style="flex-grow: 1;"></div>
                <button class="shutter-btn-large" onclick="takeSnapshot()">
                    <span style="font-size: 2.5rem;">ğŸ“¸</span> æ’®å½±
                </button>
                <p class="text-center text-muted" style="font-size:0.7rem; margin-bottom:5px;">iPhoneã¯ä¿å­˜å¾Œã«ã€Œç”»åƒã‚’ä¿å­˜ã€</p>
            </div>

            <div id="tab-edit" class="tab-content">
                <h6 class="text-center text-muted border-bottom pb-2">é»’æ¿ç·¨é›†</h6>
                <div class="preset-box">
                    <label>å®šå‹æ–‡ (å·¥äº‹åãƒ»å·¥ç¨®)</label>
                    <select id="presetSelect" class="form-control form-control-sm mb-1">
                        <option value="1">å®šå‹æ–‡ 1</option>
                        <option value="2">å®šå‹æ–‡ 2</option>
                        <option value="3">å®šå‹æ–‡ 3</option>
                        <option value="4">å®šå‹æ–‡ 4</option>
                        <option value="5">å®šå‹æ–‡ 5</option>
                    </select>
                    <div class="preset-btn-group">
                        <button class="preset-btn btn-load" onclick="loadPreset()">ğŸ“‚ èª­è¾¼</button>
                        <button class="preset-btn btn-save" onclick="savePreset()">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
                <div><label>1. å·¥äº‹å</label><input type="text" id="input1" class="form-control form-control-sm" value="R7å¹´åº¦ ä½œæ¥­é“é–‹è¨­"></div>
                <div><label>2. å·¥ç¨®</label><input type="text" id="input2" class="form-control form-control-sm" value="è·¯ç¶²ä½œè¨­å·¥"></div>
                <div><label>3. æ¸¬ç‚¹</label><input type="text" id="input3" class="form-control form-control-sm" value="No.0"></div>
                <div><label>4. æ—¥ä»˜ãƒ»å‚™è€ƒ</label><input type="text" id="input4" class="form-control form-control-sm" value=""></div>
                <div class="mt-3 text-center text-muted" style="font-size:0.8rem;">â€»å…¥åŠ›å†…å®¹ã¯ã€Œæ’®å½±ã€ã‚¿ãƒ–ã«æˆ»ã£ã¦ã‚‚ä¿æŒã•ã‚Œã¾ã™</div>
            </div>
        </div>
    </div>

<script>
    // --- Update Notification Logic ---
    let newWorker;
    function updateApp() {
        if (newWorker) {
            newWorker.postMessage({ type: 'SKIP_WAITING' });
        }
        document.getElementById('update-notification').style.display = 'none';
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            reg.addEventListener('updatefound', () => {
                newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        document.getElementById('update-notification').style.display = 'block';
                    }
                });
            });
        });
        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            window.location.reload();
            refreshing = true;
        });
    }

    // --- Tab Switching Logic ---
    function switchTab(tabName) {
        document.getElementById('tabBtn-shoot').className = (tabName === 'shoot') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tabBtn-edit').className = (tabName === 'edit') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-shoot').className = (tabName === 'shoot') ? 'tab-content active' : 'tab-content';
        document.getElementById('tab-edit').className = (tabName === 'edit') ? 'tab-content active' : 'tab-content';
    }

    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const warning = document.getElementById('portrait-warning');
    const gpsStatusDiv = document.getElementById('gpsStatus');
    
    const previewOverlay = document.getElementById('previewOverlay');
    const previewImg = document.getElementById('previewImg');
    let currentBlob = null;

    const today = new Date();
    document.getElementById('input4').value = today.getFullYear() + '/' + (today.getMonth()+1) + '/' + today.getDate();

    // --- Aspect Ratio Logic (ç”»è§’è¨­å®š) ---
    let targetRatio = 1.7777; // åˆæœŸå€¤ 16:9
    function setRatio(val) {
        targetRatio = val;
    }

    let boardPosition = 'right';
    function setBoardPos(pos) {
        boardPosition = pos;
        document.getElementById('btnLeft').className = pos === 'left' ? 'pos-btn active' : 'pos-btn';
        document.getElementById('btnRight').className = pos === 'right' ? 'pos-btn active' : 'pos-btn';
    }

    function checkOrientation() {
        warning.style.display = (window.innerWidth < window.innerHeight) ? 'flex' : 'none';
    }
    window.addEventListener('resize', checkOrientation);
    checkOrientation();

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false 
            });
            video.srcObject = stream;
        } catch (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message); }
    }
    window.onload = startCamera;

    // --- Preset Logic ---
    function savePreset() {
        const slot = document.getElementById('presetSelect').value;
        const val1 = document.getElementById('input1').value;
        const val2 = document.getElementById('input2').value;
        localStorage.setItem('preset_' + slot + '_1', val1);
        localStorage.setItem('preset_' + slot + '_2', val2);
        alert(`å®šå‹æ–‡${slot}ã«ä¿å­˜ã—ã¾ã—ãŸã€‚\nâ‘  ${val1}\nâ‘¡ ${val2}`);
    }

    function loadPreset() {
        const slot = document.getElementById('presetSelect').value;
        const val1 = localStorage.getItem('preset_' + slot + '_1');
        const val2 = localStorage.getItem('preset_' + slot + '_2');
        if (val1 !== null) document.getElementById('input1').value = val1;
        if (val2 !== null) document.getElementById('input2').value = val2;
        if (val1 === null) alert("ä¿å­˜ã•ã‚ŒãŸå®šå‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“");
    }

    // --- GPS Logic ---
    let useGPS = false;
    let currentLat = null;
    let currentLon = null;
    let currentHeading = null;
    let watchId = null;

    async function toggleGPS() {
        const checkbox = document.getElementById('gpsToggle');
        useGPS = checkbox.checked;

        if (useGPS) {
            gpsStatusDiv.innerText = "æ¸¬ä½ä¸­...";
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude.toFixed(5);
                        currentLon = pos.coords.longitude.toFixed(5);
                        updateStatusText();
                    },
                    (err) => { gpsStatusDiv.innerText = "GPSã‚¨ãƒ©ãƒ¼: " + err.message; },
                    { enableHighAccuracy: true }
                );
            }
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') window.addEventListener('deviceorientation', handleOrientation);
                } catch (e) {}
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        } else {
            gpsStatusDiv.innerText = "OFF";
            if (watchId) navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('deviceorientation', handleOrientation);
            currentLat = null; currentLon = null; currentHeading = null;
        }
    }

    function handleOrientation(event) {
        let heading = null;
        if (event.webkitCompassHeading) {
            heading = event.webkitCompassHeading;
        } else if (event.alpha) {
            heading = 360 - event.alpha; 
        }

        if (heading != null) {
            let screenAngle = 0;
            if (window.screen && window.screen.orientation && window.screen.orientation.angle) {
                screenAngle = window.screen.orientation.angle;
            } else if (typeof window.orientation !== 'undefined') {
                screenAngle = window.orientation;
            }
            heading = (heading + screenAngle) % 360;
            if (heading < 0) heading += 360;
            currentHeading = heading;
            updateStatusText();
        }
    }

    function updateStatusText() {
        if (!useGPS) return;
        let text = "";
        if (currentLat) text += `N${currentLat} E${currentLon} `;
        if (currentHeading != null) text += ` ${getCardinal(currentHeading)}`;
        gpsStatusDiv.innerText = text || "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
    }

    // --- Drawing Logic (Updated for Aspect Ratio) ---
    function drawBlackboard() {
        // 1. å…ƒã®ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º
        const srcW = video.videoWidth;
        const srcH = video.videoHeight;
        
        // 2. åˆ‡ã‚ŠæŠœãå¾Œã®ã‚µã‚¤ã‚ºè¨ˆç®— (Center Crop)
        let cropW = srcW;
        let cropH = srcH;
        
        // ãƒ“ãƒ‡ã‚ªã®ç¾åœ¨ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
        const currentVideoRatio = srcW / srcH;

        if (currentVideoRatio > targetRatio) {
            // ãƒ“ãƒ‡ã‚ªã®æ–¹ãŒæ¨ªé•· -> æ¨ªã‚’å‰Šã‚‹ (Pillarbox)
            cropW = srcH * targetRatio;
            cropH = srcH;
        } else {
            // ãƒ“ãƒ‡ã‚ªã®æ–¹ãŒç¸¦é•·(ã¾ãŸã¯æ­£æ–¹å½¢ã«è¿‘ã„) -> ç¸¦ã‚’å‰Šã‚‹ (Letterbox)
            cropW = srcW;
            cropH = srcW / targetRatio;
        }

        // åˆ‡ã‚ŠæŠœãé–‹å§‹ä½ç½®ï¼ˆä¸­å¤®å¯„ã›ï¼‰
        const cropX = (srcW - cropW) / 2;
        const cropY = (srcH - cropH) / 2;

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’åˆ‡ã‚ŠæŠœãå¾Œã«åˆã‚ã›ã‚‹
        canvas.width = cropW;
        canvas.height = cropH;
        
        // åˆ‡ã‚ŠæŠœã„ã¦æç”»
        ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

        // --- ä»¥ä¸‹ã€é»’æ¿æç”»ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆcanvasã‚µã‚¤ã‚ºä¾å­˜ãªã®ã§è‡ªå‹•è¿½å¾“ã™ã‚‹ï¼‰ ---
        const boardWidth = canvas.width * 0.25; 
        const boardHeight = boardWidth * 0.65; 
        const margin = canvas.width * 0.02;

        let x, y;
        y = canvas.height - boardHeight - margin;
        x = (boardPosition === 'right') ? (canvas.width - boardWidth - margin) : margin;

        // èƒŒæ™¯
        ctx.fillStyle = "#004d26"; 
        ctx.fillRect(x, y, boardWidth, boardHeight);
        
        // æ ç·š
        ctx.strokeStyle = "white";
        ctx.lineWidth = boardWidth * 0.01;
        ctx.strokeRect(x, y, boardWidth, boardHeight);

        // ç½«ç·š
        const rowH = boardHeight / 4;
        ctx.beginPath();
        for(let i=1; i<=3; i++) {
            ctx.moveTo(x, y + rowH * i); ctx.lineTo(x + boardWidth, y + rowH * i);
        }
        ctx.stroke();

        // æ–‡å­—
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "white";
        
        const baseFontSize = Math.floor(rowH * 0.55); 
        const texts = [
            document.getElementById('input1').value,
            document.getElementById('input2').value,
            document.getElementById('input3').value,
            document.getElementById('input4').value
        ];
        const maxTextWidth = boardWidth * 0.95; 

        for (let i = 0; i < 4; i++) {
            let fontSize = baseFontSize;
            ctx.font = `bold ${fontSize}px Arial`;
            while (ctx.measureText(texts[i]).width > maxTextWidth && fontSize > 5) {
                fontSize--;
                ctx.font = `bold ${fontSize}px Arial`;
            }
            ctx.fillText(texts[i], x + boardWidth / 2, y + (rowH * i) + (rowH / 2));
        }

        // GPSæƒ…å ±
        if (useGPS) {
            let line1 = "";
            let line2 = "";
            if (currentLat) line1 = `N${currentLat} E${currentLon}`;
            if (currentHeading != null) line2 = `æ–¹ä½: ${getCardinal(currentHeading)} (${Math.round(currentHeading)}Â°)`;
            if (!line1 && !line2) line1 = "GPSè¨ˆæ¸¬ä¸­...";

            const gpsFontSize = Math.floor(canvas.height * 0.03); 
            ctx.font = `bold ${gpsFontSize}px monospace`;

            const padding = gpsFontSize * 0.5;
            const textWidth1 = ctx.measureText(line1).width;
            const textWidth2 = ctx.measureText(line2).width;
            const maxGPSWidth = Math.max(textWidth1, textWidth2);
            
            const gpsBoxWidth = maxGPSWidth + (padding * 4);
            const lineHeight = gpsFontSize * 1.2;
            const gpsBoxHeight = (line2 ? lineHeight * 2 : lineHeight) + (padding * 2);

            const gpsX = (canvas.width - gpsBoxWidth) / 2;
            const gpsY = canvas.height - gpsBoxHeight - margin;

            ctx.fillStyle = "rgba(0, 51, 25, 0.85)"; 
            ctx.fillRect(gpsX, gpsY, gpsBoxWidth, gpsBoxHeight);

            ctx.fillStyle = "#ffff00"; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            if (line2) {
                ctx.fillText(line1, canvas.width / 2, gpsY + padding + lineHeight/2);
                ctx.fillText(line2, canvas.width / 2, gpsY + padding + lineHeight*1.5);
            } else {
                ctx.fillText(line1, canvas.width / 2, gpsY + gpsBoxHeight/2);
            }
        }
    }

    function getCardinal(angle) {
        const directions = ['Nâ†‘', 'NEâ†—', 'Eâ†’', 'SEâ†˜', 'Sâ†“', 'SWâ†™', 'Wâ†', 'NWâ†–'];
        return directions[Math.round(((angle %= 360) < 0 ? angle + 360 : angle) / 45) % 8];
    }

    function takeSnapshot() {
        drawBlackboard();
        canvas.toBlob((blob) => {
            if (!blob) return;
            currentBlob = blob;
            previewImg.src = URL.createObjectURL(blob);
            previewOverlay.style.display = 'flex';
        }, 'image/jpeg', 0.95);
    }

    function cancelPreview() {
        previewOverlay.style.display = 'none';
        URL.revokeObjectURL(previewImg.src);
        currentBlob = null;
    }

    async function savePhoto() {
        if (!currentBlob) return;
        const now = new Date();
        const fileName = `kokuban_${now.getTime()}.jpg`;
        const file = new File([currentBlob], fileName, { type: "image/jpeg" });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({ files: [file], title: 'é»’æ¿å†™çœŸ' });
                cancelPreview();
                return;
            } catch (err) {}
        }
        const link = document.createElement('a');
        link.download = fileName;
        link.href = URL.createObjectURL(currentBlob);
        link.click();
        cancelPreview();
    }
</script>
</body>
</html>
